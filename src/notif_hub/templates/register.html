{% extends "base.html" %}

{% block title %}Регистрация · Notification Hub{% endblock %}

{% block content %}
<h1>Регистрация</h1>
<p>Создайте аккаунт, чтобы использовать Notification Hub.</p>

<form id="register-form" method="post" action="/jwt/register">
  <div class="row">
    <label>
      Имя пользователя
      <input type="text" name="username" placeholder="Ваш никнейм" required>
      <span class="muted">Можно использовать латиницу, цифры и символ `_`.</span>
    </label>
  </div>

  <div class="row">
    <label>
      Email
      <input type="email" name="email" placeholder="name@example.com" required>
      <span class="muted">На этот адрес мы сможем отправлять уведомления.</span>
    </label>
  </div>

  <div class="row">
    <label>
      Пароль
      <input type="password" name="password" placeholder="Придумайте надёжный пароль" required minlength="8">
      <span class="muted">Минимум 8 символов. Рекомендуется использовать буквы, цифры и спецсимволы.</span>
    </label>
  </div>

  <div class="actions">
    <button type="submit">Зарегистрироваться</button>
  </div>
</form>

<div id="register-error" class="status hidden" aria-live="polite"></div>

<div style="margin-top: 24px; border-top: 1px solid var(--border); padding-top: 20px; display: grid; gap: 12px;">
  <div class="muted">Или войдите с помощью одного из сервисов:</div>
  <div class="row">
    <a href="/google/url" class="nav-link-button" style="justify-content: center; width: 100%; text-align: center;">
      Войти с помощью Google
    </a>
    <a href="/github/url" class="nav-link-button" style="justify-content: center; width: 100%; text-align: center;">
      Войти с помощью GitHub
    </a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (() => {
    const form = document.getElementById("register-form");
    if (!form) return;

    const errorBox = document.getElementById("register-error");

    function showError(message) {
      if (!errorBox) return;
      errorBox.textContent = message;
      errorBox.classList.remove("hidden");
      errorBox.style.color = "var(--danger)";
    }

    function clearError() {
      if (!errorBox) return;
      errorBox.textContent = "";
      errorBox.classList.add("hidden");
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      clearError();

      if (!form.reportValidity()) {
        return;
      }

      try {
        const formData = new FormData(form);

        const response = await fetch("/jwt/register", {
          method: "POST",
          body: formData,
        });

        if (response.redirected) {
          window.location.href = response.url;
          return;
        }

        if (!response.ok) {
          let message = "Не удалось завершить регистрацию. Попробуйте позже.";

          try {
            const data = await response.json();
            if (data) {
              if (typeof data.detail === "string") {
                message = data.detail;
              } else if (Array.isArray(data.detail)) {
                const first = data.detail[0];
                if (first && typeof first.msg === "string") {
                  message = first.msg;
                }
              }
            }
          } catch (_) {
            
          }

          showError(message);
          return;
        }

        // На случай, если редиректа не произошло, но регистрация прошла успешно
        // window.location.href = "/jwt/login";
      } catch (e) {
        console.error(e);
        showError("Произошла ошибка сети. Проверьте подключение и попробуйте снова.");
      }
    });
  })();
</script>
{% endblock %}