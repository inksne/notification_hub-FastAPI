{% extends "base.html" %}

{% block title %}Успешная аутентификация · Notification Hub{% endblock %}

{% block top_nav_guest %}{% endblock %}

{% block top_nav_auth %}
<form action="/jwt/logout" method="post" style="margin: 0;">
  <button type="submit" class="nav-link-button">Выйти</button>
</form>
{% endblock %}

{% block content %}
<h1>Вы авторизованы</h1>
<p id="auth-status" class="muted">Проверяем данные авторизации…</p>
<pre id="auth-user" class="status hidden" style="margin-top: 16px; white-space: pre-wrap;"></pre>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  (() => {
    const params = new URLSearchParams(window.location.search || "");
    const code = params.get("code");
    const state = params.get("state");
    const error = params.get("error");


    let provider = null;
    if (typeof state === "string") {
      if (state.startsWith("google:")) {
        provider = "google";
      } else if (state.startsWith("github:")) {
        provider = "github";
      }
    }

    const statusEl = document.getElementById("auth-status");
    const userEl = document.getElementById("auth-user");

    if (!statusEl || !userEl) {
      return;
    }

    function setStatus(message, colorVar = "--muted") {
      statusEl.textContent = message;
      statusEl.style.color = `var(${colorVar})`;
    }

    if (error) {
      setStatus(`Произошла ошибка при аутентификации: ${error}`, "--danger");
      return;
    }

    function getCallbackUrl(providerName) {
      if (providerName === "google") return "/google/callback";
      if (providerName === "github") return "/github/callback";
      return null;
    }

    async function callCallback(url) {
      const response = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ code, state })
      });

      if (!response.ok) {
        const text = await response.text();
        throw new Error(`Запрос к ${url} завершился с ошибкой ${response.status}: ${text}`);
      }

      return response.json();
    }

    (async () => {
      try {
        let data;
        const callbackUrl = getCallbackUrl(provider);

        if (callbackUrl) {
          data = await callCallback(callbackUrl);
        } else {
          setStatus(`Аутентификация по JWT выполнена успешно.`, "--accent");
        }


        if (data && data.user) {
          userEl.textContent = JSON.stringify(data.user, null, 2);
          userEl.classList.remove("hidden");
        }

        const ACCESS_TOKEN_LIFETIME_MS = 300 * 1000;

        async function refreshAccessToken() {
          try {
            const resp = await fetch("/jwt/refresh", {
              method: "POST",
              credentials: "include"
            });

            if (!resp.ok) {
              const text = await resp.text();
              console.error("Ошибка при обновлении access токена:", resp.status, text);
              setStatus("Не удалось обновить access токен. Перезайдите в систему.", "--danger");
              return;
            }

            const refreshed = await resp.json();
            console.info("Access токен успешно обновлён:", refreshed);
            setStatus("Сессия продлена, access токен обновлён.", "--accent");

            scheduleAccessTokenRefresh();
          } catch (err) {
            console.error("Ошибка сети при обновлении access токена:", err);
            setStatus("Проблема с сетью при обновлении токена. Попробуйте перезагрузить страницу.", "--danger");
          }
        }

        function scheduleAccessTokenRefresh() {
          window.setTimeout(() => {
            refreshAccessToken();
          }, ACCESS_TOKEN_LIFETIME_MS);
        }

        scheduleAccessTokenRefresh();
      } catch (e) {
        console.error(e);
        setStatus("Не удалось получить данные пользователя по коду авторизации. Попробуйте снова.", "--danger");
      }
    })();
  })();
</script>
{% endblock %}