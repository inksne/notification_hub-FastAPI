<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Notification Hub{% endblock %}</title>

  {% block head %}
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0f172a;
      --card: #1e293b;
      --border: #334155;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #38bdf8;
      --danger: #ef4444;
      --shadow: 0 20px 70px -40px rgba(0,0,0,.75);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr auto;
    }
    header, footer {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: color-mix(in srgb, var(--card) 70%, transparent);
    }
    footer { border-top: 1px solid var(--border); border-bottom: none; }
    main {
      display: flex;
      justify-content: center;
      padding: 32px 16px 48px;
    }
    .shell {
      width: min(900px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow);
    }
    h1, h2, h3 {
      margin: 0 0 8px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    p { margin: 0 0 16px; color: var(--muted); }
    form {
      display: grid;
      gap: 16px;
    }
    label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-weight: 600;
      color: var(--text);
    }
    select, textarea, input[type="text"], input[type="email"], input[type="url"], input[type="password"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--bg) 70%, transparent);
      color: var(--text);
      font-size: 14px;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    select:focus, textarea:focus, input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 35%, transparent);
    }
    textarea { min-height: 120px; resize: vertical; }
    .row { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .channel-layout {
      display: grid;
      gap: 24px;
      grid-template-columns: auto 1fr;
      align-items: start;
    }
    .channel-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: color-mix(in srgb, var(--bg) 70%, transparent);
      min-width: 180px;
    }
    .channel-option {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: var(--text);
    }
    .channel-option input {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }
    .channel-fields {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .channel-fields label {
      opacity: 1;
      transition: opacity 0.2s ease;
    }
    .channel-fields label:has(input:disabled) {
      opacity: 0.4;
    }
    .channel-fields input:disabled {
      cursor: not-allowed;
      background: color-mix(in srgb, var(--bg) 50%, transparent);
    }
    .channel-fields [data-field="webhook"] {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .muted { color: var(--muted); font-size: 13px; }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--accent) 18%, transparent);
      color: var(--accent);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      text-decoration: none;
    }
    .top-nav {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 12px;
    }
    .nav-link-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
      text-decoration: none;
      transition: background-color .15s ease, color .15s ease, border-color .15s ease;
    }
    .nav-link-button:hover {
      background: color-mix(in srgb, var(--accent) 18%, transparent);
      color: var(--accent);
      border-color: var(--accent);
    }
    .actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      align-items: center;
    }
    button {
      border: none;
      border-radius: 10px;
      padding: 12px 18px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: transform .1s ease, box-shadow .15s ease, background-color .2s ease;
      background: linear-gradient(135deg, #0ea5e9, #22d3ee);
      color: #0b1222;
      box-shadow: 0 10px 40px -15px rgba(34, 211, 238, .8);
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    .ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
      box-shadow: none;
    }
    .hidden { display: none !important; }
    .status {
      padding: 10px 12px;
      border-radius: 10px;
      background: color-mix(in srgb, var(--border) 60%, transparent);
      color: var(--muted);
      font-size: 13px;
      border: 1px dashed var(--border);
    }
    @media (max-width: 640px) {
      header, footer { padding: 14px 16px; }
      .shell { padding: 18px; }
    }
  </style>
  {% endblock %}

</head>
<body>
  <header>
    <div class="row" style="grid-template-columns: auto 1fr;">
      <a href="/" class="pill">Notification Hub</a>
      <div class="top-nav">
        <div class="muted">Единая отправка сообщений</div>
        <a href="/about" class="nav-link-button">О проекте</a>
        {% block top_nav_guest %}
        <a href="/jwt/register" class="nav-link-button">Регистрация</a>
        <a href="/jwt/login" class="nav-link-button">Войти</a>
        {% endblock %}
        {% block top_nav_auth %}{% endblock %}
      </div>
    </div>
  </header>

  <main>
    <div class="shell">
      {% block content %}
      <h1>Отправить уведомление</h1>
      <p>Введите сообщение и выберите, куда его доставить.</p>

      <form id="send-form" method="post" action="/send">
        <label>
          Сообщение
          <textarea name="message" id="message" placeholder="Напишите что угодно..." required></textarea>
          <span class="muted">Можно использовать простой текст или markdown.</span>
        </label>

        <div class="channel-layout">
          <div>
            <div class="muted" style="margin-bottom:6px;">Каналы</div>
            <div class="channel-list" id="channel-list">
              <label class="channel-option">
                <input type="checkbox" name="channels" value="telegram">
                Telegram
              </label>
              <label class="channel-option">
                <input type="checkbox" name="channels" value="email">
                Email
              </label>
              <label class="channel-option">
                <input type="checkbox" name="channels" value="webhook">
                Webhook
              </label>
            </div>
            <span class="muted">Можно выбрать один или несколько каналов.</span>
          </div>

          <div class="channel-fields">
            <label data-field="telegram">
              Telegram аккаунт
              <input type="text" name="telegram_to" id="telegram_to" placeholder="@username" disabled>
              <span class="muted">Пользователь, группа или канал.</span>
              <span class="muted">Важно: пользователь должен начать диалог с ботом, чтобы получить сообщение.</span>
            </label>

            <label data-field="email">
              Email адрес
              <input type="email" name="email_to" id="email_to" placeholder="name@example.com" disabled>
              <span class="muted">Почтовый ящик получателя.</span>
            </label>

            <div data-field="webhook">
              <label>
                Webhook URL
                <input type="url" name="webhook_url" id="webhook_url" placeholder="https://example.com/webhook" disabled>
                <span class="muted">Доступная извне HTTPS-точка.</span>
              </label>

              <label>
                Формат данных
                <select name="webhook_format" id="webhook_format" disabled>
                  <option value="json">JSON</option>
                  <option value="text">Text</option>
                  <option value="form">Form</option>
                </select>
                <span class="muted">Формат отправки данных в webhook.</span>
              </label>

              <label id="webhook_param_name_label" style="display: none;">
                Название параметра
                <input type="text" name="webhook_param_name" id="webhook_param_name" placeholder="msg" disabled>
                <span class="muted">Название параметра для формата Form.</span>
              </label>
            </div>
          </div>
        </div>

        <div class="actions">
          <button type="reset" class="ghost">Сбросить</button>
          <button type="submit">Отправить</button>
        </div>

        <div class="status" id="status" aria-live="polite">
          Готово к отправке. Выберите канал, чтобы увидеть обязательные поля.
        </div>
      </form>
      {% endblock %}
    </div>
  </main>

  {% block scripts %}
  <script>
    (() => {
      const form = document.getElementById("send-form");
      const channelList = document.getElementById("channel-list");
      const status = document.getElementById("status");
      const messageInput = document.getElementById("message");
      if (!form || !channelList || !status || !messageInput) {
        return;
      }

      const fieldMap = {
        email: document.querySelector('[data-field="email"]'),
        telegram: document.querySelector('[data-field="telegram"]'),
        webhook: document.querySelector('[data-field="webhook"]')
      };
      const channelCheckboxes = [...channelList.querySelectorAll('input[type="checkbox"]')];

      function updateWebhookParamField() {
        const webhookChecked = channelCheckboxes.find(cb => cb.value === "webhook" && cb.checked);
        const formatSelect = document.getElementById("webhook_format");
        const paramNameLabel = document.getElementById("webhook_param_name_label");
        const paramNameInput = document.getElementById("webhook_param_name");
        
        if (webhookChecked && formatSelect.value === "form") {
          paramNameLabel.style.display = "flex";
          paramNameInput.disabled = false;
          paramNameInput.required = true;
        } else {
          paramNameLabel.style.display = "none";
          paramNameInput.disabled = true;
          paramNameInput.required = false;
          if (!webhookChecked || formatSelect.value !== "form") {
            paramNameInput.value = "";
          }
        }
      }

      function updateFields() {
        const selected = channelCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
        Object.entries(fieldMap).forEach(([key, el]) => {
          const inputs = el.querySelectorAll("input, select");
          const visible = selected.includes(key);
          inputs.forEach(input => {
            // Пропускаем поле param_name, оно управляется отдельно
            if (input.id === "webhook_param_name") {
              return;
            }
            input.disabled = !visible;
            input.required = visible;
            if (!visible) {
              if (input.tagName === "SELECT") {
                input.selectedIndex = 0;
              } else {
                input.value = "";
              }
            }
          });
        });
        updateWebhookParamField();
        status.textContent = selected.length
          ? `Выбрано каналов: ${selected.join(", ")}. Заполните обязательные поля.`
          : "Готово к отправке. Выберите канал, чтобы увидеть обязательные поля.";
        status.style.color = "var(--muted)";
      }

      async function handleSubmit(event) {
        event.preventDefault();

        const hasSelection = channelCheckboxes.some(cb => cb.checked);
        if (!hasSelection) {
          status.textContent = "Пожалуйста, выберите хотя бы один канал.";
          status.style.color = "var(--danger)";
          return;
        }

        if (!form.reportValidity()) {
          return;
        }

        status.textContent = "Отправляем…";
        status.style.color = "var(--muted)";

        const selected = channelCheckboxes.filter(cb => cb.checked).map(cb => cb.value);

        const payload = {
          messages: {},
          channels: selected,
          targets: {}
        };

        const baseMessage = messageInput.value;

        selected.forEach(channel => {
          payload.messages[channel] = baseMessage;

          if (channel === "telegram") {
            const input = fieldMap.telegram.querySelector("input");
            if (input.value) {
              payload.targets.telegram = input.value;
            }
          }

          if (channel === "email") {
            const input = fieldMap.email.querySelector("input");
            if (input.value) {
              payload.targets.email = input.value;
            }
          }

          if (channel === "webhook") {
            const urlInput = fieldMap.webhook.querySelector("input[type='url']");
            const formatSelect = fieldMap.webhook.querySelector("select");
            const paramNameInput = document.getElementById("webhook_param_name");
            
            if (urlInput.value && formatSelect.value) {
              const webhookTarget = {
                url: urlInput.value,
                format: formatSelect.value
              };
              
              // Для формата form используем значение из поля, иначе значение по умолчанию
              if (formatSelect.value === "form") {
                webhookTarget.param_name = paramNameInput.value || "message";
              } else {
                webhookTarget.param_name = "message";
              }
              
              payload.targets.webhook = webhookTarget;
            }
          }
        });

        try {
          const response = await fetch("/api/v1/channels", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            // Пытаемся извлечь сообщение об ошибке из ответа
            let errorMessage = "Не удалось отправить уведомление. Попробуйте ещё раз позже.";
            
            try {
              const errorData = await response.json();
              if (errorData && errorData.detail) {
                errorMessage = errorData.detail;
              }
            } catch (jsonError) {
              // Если не удалось распарсить JSON, используем сообщение по умолчанию
              console.error("Не удалось распарсить ответ об ошибке:", jsonError);
            }
            
            status.textContent = errorMessage;
            status.style.color = "var(--danger)";
            return;
          }

          status.textContent = "Уведомление успешно отправлено.";
          status.style.color = "var(--accent)";
        } catch (e) {
          console.error(e);
          status.textContent = "Не удалось отправить уведомление. Попробуйте ещё раз позже.";
          status.style.color = "var(--danger)";
        }
      }

      channelCheckboxes.forEach(cb => cb.addEventListener("change", updateFields));
      
      const formatSelect = document.getElementById("webhook_format");
      if (formatSelect) {
        formatSelect.addEventListener("change", updateWebhookParamField);
      }
      
      form.addEventListener("submit", handleSubmit);
      form.addEventListener("reset", () => {
        setTimeout(() => {
          channelCheckboxes.forEach(cb => { cb.checked = false; });
          updateFields();
          status.textContent = "Форма очищена. Выберите канал, чтобы продолжить.";
          status.style.color = "var(--muted)";
        }, 0);
      });

      updateFields();
    })();
  </script>
  {% endblock %}
</body>
</html>